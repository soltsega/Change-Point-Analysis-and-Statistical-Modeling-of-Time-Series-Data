<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš€ Brent Oil Price Change Point Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-inputs input {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .events-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .event-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-date {
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 4px;
        }

        .event-description {
            color: #333;
            margin-bottom: 4px;
        }

        .impact-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .impact-high {
            background: #ff4d4f;
            color: white;
        }

        .impact-extreme {
            background: #722ed1;
            color: white;
        }

        .impact-medium {
            background: #fa8c16;
            color: white;
        }

        .impact-low {
            background: #52c41a;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .change-point-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .change-point-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .change-point-stat {
            text-align: center;
        }

        .change-point-value {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .change-point-label {
            opacity: 0.9;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .date-inputs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ðŸš€ Brent Oil Price Change Point Analysis</h1>
            <button class="refresh-btn" onclick="loadData()">ðŸ”„ Refresh Data</button>
        </div>
    </div>

    <div class="container">
        <div id="error-message"></div>
        <div id="loading" class="loading">Loading dashboard...</div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-row">
                <div class="date-inputs">
                    <label>ðŸ“… Date Range:</label>
                    <input type="date" id="start-date" value="2020-01-01">
                    <span>to</span>
                    <input type="date" id="end-date" value="2026-02-06">
                    <button class="refresh-btn" onclick="filterData()">Apply Filter</button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div id="stats-grid" class="stats-grid"></div>

        <!-- Change Point Analysis -->
        <div id="change-point-card" class="change-point-card" style="display: none;">
            <h2 style="margin-bottom: 20px;">ðŸŽ¯ Change Point Analysis</h2>
            <div id="change-point-stats" class="change-point-stats"></div>
        </div>

        <!-- Price Chart -->
        <div class="chart-container">
            <h2 class="chart-title">ðŸ“ˆ Price Series with Change Point</h2>
            <div class="chart-wrapper">
                <canvas id="price-chart"></canvas>
            </div>
        </div>

        <!-- Volatility Chart -->
        <div class="chart-container">
            <h2 class="chart-title">ðŸ“Š Volatility Analysis</h2>
            <div class="chart-wrapper">
                <canvas id="volatility-chart"></canvas>
            </div>
        </div>

        <!-- Events List -->
        <div class="events-list">
            <h2 class="chart-title">ðŸ“‹ Major Events</h2>
            <div id="events-container"></div>
        </div>
    </div>

    <script>
        let priceChart = null;
        let volatilityChart = null;
        let currentData = null;
        let currentEvents = null;
        let currentChangePoint = null;

        // Initialize dashboard
        async function init() {
            await loadData();
        }

        // Load all data
        async function loadData() {
            try {
                showLoading(true);
                hideError();

                // Load data in parallel
                const [dataResponse, eventsResponse, changePointResponse, analysisResponse] = await Promise.all([
                    fetch('/api/data'),
                    fetch('/api/events'),
                    fetch('/api/change-point'),
                    fetch('/api/analysis')
                ]);

                if (!dataResponse.ok || !eventsResponse.ok || !changePointResponse.ok || !analysisResponse.ok) {
                    throw new Error('Failed to load data');
                }

                currentData = await dataResponse.json();
                currentEvents = await eventsResponse.json();
                currentChangePoint = await changePointResponse.json();
                const analysis = await analysisResponse.json();

                // Update UI
                updateStats(analysis);
                updateChangePoint(currentChangePoint);
                updateCharts(currentData, currentChangePoint);
                updateEvents(currentEvents.events || []);

                showLoading(false);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please make sure the Flask backend is running on http://localhost:5000');
                showLoading(false);
            }
        }

        // Filter data by date range
        async function filterData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            try {
                showLoading(true);
                hideError();

                const [dataResponse, eventsResponse] = await Promise.all([
                    fetch(`/api/data?start_date=${startDate}&end_date=${endDate}`),
                    fetch(`/api/events?start_date=${startDate}&end_date=${endDate}`)
                ]);

                if (!dataResponse.ok || !eventsResponse.ok) {
                    throw new Error('Failed to load filtered data');
                }

                currentData = await dataResponse.json();
                currentEvents = await eventsResponse.json();

                updateCharts(currentData, currentChangePoint);
                updateEvents(currentEvents.events || []);

                showLoading(false);

            } catch (error) {
                console.error('Error loading filtered data:', error);
                showError('Failed to load filtered data');
                showLoading(false);
            }
        }

        // Update statistics
        function updateStats(analysis) {
            const statsGrid = document.getElementById('stats-grid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${analysis.summary_stats?.total_observations || 0}</div>
                    <div class="stat-label">ðŸ“Š Total Observations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${(analysis.summary_stats?.price_stats?.min || 0).toFixed(2)} - $${(analysis.summary_stats?.price_stats?.max || 0).toFixed(2)}</div>
                    <div class="stat-label">ðŸ’° Price Range</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(analysis.summary_stats?.returns_stats?.mean || 0).toFixed(6)}</div>
                    <div class="stat-label">ðŸ“ˆ Mean Return</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(analysis.summary_stats?.returns_stats?.std || 0).toFixed(4)}</div>
                    <div class="stat-label">ðŸ“Š Volatility</div>
                </div>
            `;
        }

        // Update change point analysis
        function updateChangePoint(changePoint) {
            const card = document.getElementById('change-point-card');
            const stats = document.getElementById('change-point-stats');
            
            card.style.display = 'block';
            
            stats.innerHTML = `
                <div class="change-point-stat">
                    <div class="change-point-value">${changePoint.date}</div>
                    <div class="change-point-label">ðŸ“… Change Point Date</div>
                </div>
                <div class="change-point-stat">
                    <div class="change-point-value">${changePoint.mean_shift.toFixed(6)}</div>
                    <div class="change-point-label">ðŸ“ˆ Mean Shift</div>
                </div>
                <div class="change-point-stat">
                    <div class="change-point-value">${changePoint.volatility_change.toFixed(1)}%</div>
                    <div class="change-point-label">ðŸ“Š Volatility Change</div>
                </div>
            `;
        }

        // Update charts
        function updateCharts(data, changePoint) {
            updatePriceChart(data, changePoint);
            updateVolatilityChart(data);
        }

        // Update price chart
        function updatePriceChart(data, changePoint) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            const chartData = {
                labels: data.dates,
                datasets: [{
                    label: 'Price',
                    data: data.prices,
                    borderColor: '#1890ff',
                    backgroundColor: 'rgba(24, 144, 255, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `Price: $${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        ticks: {
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Price ($)'
                        }
                    }
                }
            };

            // Add change point line if available
            if (changePoint && changePoint.date) {
                const changePointIndex = data.dates.indexOf(changePoint.date);
                if (changePointIndex >= 0) {
                    options.plugins.annotation = {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: changePointIndex,
                                xMax: changePointIndex,
                                borderColor: '#ff4d4f',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Change Point',
                                    enabled: true,
                                    position: 'top'
                                }
                            }
                        }
                    };
                }
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: options
            });
        }

        // Update volatility chart
        function updateVolatilityChart(data) {
            const ctx = document.getElementById('volatility-chart').getContext('2d');
            
            if (volatilityChart) {
                volatilityChart.destroy();
            }

            // Calculate rolling volatility
            const windowSize = 30;
            const rollingVolatility = [];
            for (let i = windowSize; i < data.log_returns.length; i++) {
                const window = data.log_returns.slice(i - windowSize, i);
                const volatility = Math.sqrt(window.reduce((sum, val) => sum + val * val, 0) / windowSize);
                rollingVolatility.push(volatility);
            }

            const chartData = {
                labels: data.dates.slice(windowSize),
                datasets: [{
                    label: 'Rolling Volatility',
                    data: rollingVolatility,
                    borderColor: '#52c41a',
                    backgroundColor: 'rgba(82, 196, 26, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `Volatility: ${context.parsed.y.toFixed(4)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        ticks: {
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Volatility'
                        }
                    }
                }
            };

            volatilityChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: options
            });
        }

        // Update events list
        function updateEvents(events) {
            const container = document.getElementById('events-container');
            
            if (events.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No events found in the selected date range.</p>';
                return;
            }

            container.innerHTML = events.map(event => `
                <div class="event-item">
                    <div class="event-date">${event.date}</div>
                    <div class="event-description">${event.event}</div>
                    <span class="impact-badge impact-${event.impact.toLowerCase()}">${event.impact} Impact</span>
                </div>
            `).join('');
        }

        // UI helper functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('error-message').innerHTML = `<div class="error">${message}</div>`;
        }

        function hideError() {
            document.getElementById('error-message').innerHTML = '';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
